include:
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/python-tests.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/k3s-docker-build-arm.yml'
#  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/k3s-deploy.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/github.yml'

stages:
  - unittest
  - build
  - release
  - deploy

variables:
  VERSION: '0.4'
  DEPLOYMENT: manifests/deployment.yml

# Don't run for new tags
workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

k3s-deploy:
  stage: deploy
  image: clambin/kube-installer:v1.18.8-arm
  tags:
    - k3s
    - arm
    - rpi
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG" | base64 -d > ~/.kube/config
    - if [[ -f $DEPLOYMENT.template ]]; then \
        sed -e "s#__IMAGE__#$IMAGE#g" -e "s#__TAG__#$TAG#g" $DEPLOYMENT.template > $DEPLOYMENT; \
      fi
  script:
    # TODO: requires cluster-admin. Restrict permissions?
    - kubectl apply -f $DEPLOYMENT
