include:
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/python-tests.yml'
#  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/arm64/docker-build-multiarch.yml'
#  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/docker-swarm-deploy.yml'
#  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/github.yml'

stages:
  - unittest
  - build
  - release
  - deploy

variables:
  VERSION: '0.4'
  DOCKER_SWARM_SERVICE: 'monitor_mediamon'

# Don't run for new tags
workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

.docker:
  image: docker:stable
  services:
    - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
    # gitlab-runner installed w/ helm doesn't support TLS
    DOCKER_HOST: tcp://localhost:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_CLI_EXPERIMENTAL: enabled
  tags:
    - k3s
    - arm
    - rpi
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - export CI_PROJECT_PATH=$(echo $CI_PROJECT_PATH | tr "[:upper:]" "[:lower:]")


build:
  stage: build
  extends:
    - .docker
  script:
    # add "-network host": IPv6 issue when running in docker containers
    - docker build --network host --pull -t $CI_PROJECT_PATH:$CI_COMMIT_BRANCH .
    - docker push $CI_PROJECT_PATH:$CI_COMMIT_BRANCH

publish:
  stage: release
  extends: .docker
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
  script:
    - docker pull $CI_PROJECT_PATH:$CI_COMMIT_BRANCH
    - docker tag  $CI_PROJECT_PATH:$CI_COMMIT_BRANCH $CI_PROJECT_PATH:$VERSION
    - docker push $CI_PROJECT_PATH:$VERSION
    - docker tag  $CI_PROJECT_PATH:$CI_COMMIT_BRANCH $CI_PROJECT_PATH:latest
    - docker push $CI_PROJECT_PATH:latest

k3s-deploy:
  stage: deploy
  image: clambin/kube-installer:v1.18.8-arm
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG" | base64 -d > ~/.kube/config
  script:
    - kubeconfig apply -f manifest/deployment.yml
